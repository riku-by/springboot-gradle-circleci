version: 2.1

workflows:
  general-workflow:
    jobs:
      # - build
      # - unit-test
      # - jacoco-test
      # - checkstyle
      # - dependencycheck
      - sonarqube




jobs:
  build:    
    docker:
      - image: cimg/openjdk:17.0.6    
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "build.gradle" }}
            - v1-dependencies-

      - run: gradle build -x test -x check

      - save_cache:
          paths:
            - ~/.gradle
          key: v1-dependencies-{{ checksum "build.gradle" }}

  unit-test:
    docker:
      - image: cimg/openjdk:17.0.6
    steps:
      - checkout
      - when:
          condition:
            equal: [ "true", "true" ]
          steps:
            - run: gradle test
  jacoco-test:
    docker:
    - image: cimg/openjdk:17.0.6
    steps:
    - checkout
    - when:
          condition:
            equal: [ "true", "false" ]
          steps:
            - run: gradle jacocoTestReport

  checkstyle:
    docker:
    - image: cimg/openjdk:17.0.6
    steps:
    - checkout
    # - run: wget -p 

  dependencycheck:
    docker:
    - image: cimg/openjdk:17.0.6
    steps:
    - checkout

    # - run: gradle dependencyCheckAnalyze
    
  sonarqube:
    working_directory: ~/repo
    docker:
    - image: cimg/openjdk:17.0.6
    steps:
    - checkout
    
    - run:
        name: Install SonarScanner
        command: |
          mkdir -p ~/repo/SonarScanner
          wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
          unzip -qq sonar-scanner-cli-4.8.0.2856-linux.zip -d ~/repo/SonarScanner          
    # - run:
    #     name: Get GitHub Info
    #     command: |
    #       echo "Vendor name: $VENDOR_NAME"
    #       echo "GitHub Repo Name: ${CIRCLE_PROJECT_REPONAME}"
    #       echo "projectKey: $VENDOR_NAME"_"${CIRCLE_PROJECT_REPONAME}"

    - run: 
        command: |
          ~/repo/SonarScanner/sonar-scanner-4.8.0.2856-linux/bin/sonar-scanner --debug \
            # SonarQubeログイン用URL
            -Dsonar.host.url="$SONARQUBE_URL" \
            # SonarQubeログイン時に使用するトークン
            -Dsonar.login="$SONARQUBE_TOKEN" \
            # SonarQubeのプロジェクト名の先頭に付与するベンダー名
            -Dsonar.organization="$VENDOR_NAME" \
            # SonarQubeのプロジェクト名
            -Dsonar.projectKey="$VENDOR_NAME"_"${CIRCLE_PROJECT_REPONAME}"
          
    # - run: ls
    # - run: sonar-scanner/bin/
    # - run: ls
